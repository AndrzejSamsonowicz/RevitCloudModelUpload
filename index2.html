<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autodesk APS Authentication and Hubs</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Artifact+Elements:wght@400;700&display=swap');
        
        * {
            font-family: 'Artifact Elements', Arial, sans-serif;
        }
        
        /* Auth loading overlay */
        #authLoadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0696D7 0%, #0057A0 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        #authLoadingOverlay .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        body.auth-verified #authLoadingOverlay {
            display: none;
        }
        
        .hub-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 14px;
            font-family: 'Artifact Elements', Arial, sans-serif;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hub-name {
            font-weight: 500;
        }
        
        .hub-region {
            color: #6c757d;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .hub-item:hover {
            background-color: #e9ecef;
        }
        
        .hub-item.selected {
            background-color: #0696D7;
            color: white;
        }
        
        .hub-item.selected .hub-region {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .no-results {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
            font-family: 'Artifact Elements', Arial, sans-serif;
        }
        
        /* Unified button styling */
        button, .btn {
            background-color: #0696D7 !important;
            color: white !important;
            padding: 12px 20px !important;
            border: none !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-size: 14px !important;
            font-family: 'Artifact Elements', Arial, sans-serif !important;
            font-weight: 400 !important;
            min-width: 200px !important;
            height: 44px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: background-color 0.2s ease !important;
            margin: 4px !important;
        }
        
        button:hover, .btn:hover {
            background-color: #0580C0 !important;
        }
        
        button:active, .btn:active {
            background-color: #046BA5 !important;
        }
        
        /* User Management Modal Styles */
        .user-modal {
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: none;
        }

        .user-modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border: 1px solid #888;
            width: 95%;
            height: 90%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-family: 'Artifact Elements', Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }

        .user-modal-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .user-modal-header h3 {
            margin: 0;
            color: #333;
            font-family: 'Artifact Elements', Arial, sans-serif;
        }

        .user-modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            font-family: 'Artifact Elements', Arial, sans-serif;
        }

        .user-modal-close:hover,
        .user-modal-close:focus {
            color: #000;
        }

        .user-modal-body {
            padding: 20px;
            font-family: 'Artifact Elements', Arial, sans-serif;
            flex: 1;
            overflow-y: auto;
        }

        /* Table styles within modal */
        .modal-table-container {
            overflow-x: auto;
            height: 100%;
        }
        
        .modal-table {
            border-collapse: collapse;
            width: 100%;
            min-width: 1200px;
            font-family: 'Artifact Elements', Arial, sans-serif;
        }
        
        .modal-table th, .modal-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-family: 'Artifact Elements', Arial, sans-serif;
        }
        
        .modal-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            font-family: 'Artifact Elements', Arial, sans-serif;
            font-weight: 700;
        }
        
        .modal-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .modal-editable {
            min-width: 200px;
        }
        
        .modal-table-actions {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-access-cell {
            background: white;
            cursor: pointer;
            user-select: none;
            text-align: center;
        }
        
        .modal-access-cell.selected {
            background-color: #e3f2fd;
            border: 1px solid #2196F3;
        }
        
        .modal-access-cell.selecting {
            background-color: #bbdefb;
        }
        
        .modal-access-cell.error {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .modal-access-cell.administrator {
            background-color: #e8f5e9;
            font-weight: bold;
        }
        
        .modal-tooltip {
            position: absolute;
            background-color: white;
            color: black;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 4000;
            max-width: 300px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            font-family: 'Artifact Elements', Arial, sans-serif;
            border: 1px solid #ccc;
        }
        
        .modal-table-summary {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Artifact Elements', Arial, sans-serif;
        }
        
        .modal-error-cell {
            background-color: #ffebee;
            border: 1px solid #d32f2f;
        }
        
        /* Project Action Buttons */
        .project-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            outline: none;
        }
        
        .project-btn-update {
            background-color: #007bff;
            color: white;
            border: 1px solid #007bff;
        }
        
        .project-btn-update:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        
        .project-btn-add {
            background-color: #28a745;
            color: white;
            border: 1px solid #28a745;
        }
        
        .project-btn-add:hover {
            background-color: #1e7e34;
            border-color: #1e7e34;
        }
        
        .project-btn-delete {
            background-color: #dc3545;
            color: white;
            border: 1px solid #dc3545;
        }
        
        .project-btn-delete:hover {
            background-color: #c82333;
            border-color: #c82333;
        }
    </style>
</head>
<body style="font-family: 'Artifact Elements', Arial, sans-serif;">
    <!-- Auth loading overlay -->
    <div id="authLoadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <h1 style="font-family: 'Artifact Elements', Arial, sans-serif; margin-left: 20px;">ACC User Management</h1>
    <div id="login" style="display: flex; flex-direction: column; align-items: flex-start; gap: 10px; margin-bottom: 20px;">
        <button onclick="logout()">Logout</button>
        <button onclick="showCredentialsModal()">Settings</button>
        <button onclick="login()">Login with Autodesk</button>
    </div>
    <div id="error" style="display: none; color: red; font-family: 'Artifact Elements', Arial, sans-serif;"></div>
    <div id="content" style="display: none;">
        <div style="display: flex; height: 80vh;">
            <!-- Left side - Hubs list (1/4 width) -->
            <div id="hubsPanel" style="width: 25%; border-right: 2px solid #ddd; padding: 20px; overflow-y: auto; font-family: 'Artifact Elements', Arial, sans-serif;">
                <!-- Logout Button -->
                <div style="margin-bottom: 15px;">
                    <button onclick="logout()" style="
                        background-color: #0696D7;
                        color: white;
                        border: none;
                        padding: 8px 16px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-family: 'Artifact Elements', Arial, sans-serif;
                        font-size: 14px;
                        width: 100%;
                    ">
                        Logout
                    </button>
                </div>
                
                <h3 style="font-family: 'Artifact Elements', Arial, sans-serif;">Hubs</h3>
                <div id="hubsFilter" style="margin-bottom: 15px;">
                    <input type="text" id="hubFilter" placeholder="Filter hubs..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Artifact Elements', Arial, sans-serif;">
                </div>
                <div id="hubsList"></div>
            </div>
            
            <!-- Right side - Projects list (3/4 width) -->
            <div id="projectsPanel" style="width: 75%; padding: 20px; overflow-y: auto; font-family: 'Artifact Elements', Arial, sans-serif;">
                <div id="projectsHeader" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 id="selectedHubTitle" style="font-family: 'Artifact Elements', Arial, sans-serif;">Select a hub to view projects</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="openUserManagementModal()">
                                Users Main List
                            </button>
                            <button id="viewAccountUsersBtn" onclick="" style="display: none;">
                                View Account Users
                            </button>
                        </div>
                    </div>
                    
                    <!-- Project Filter -->
                    <div id="projectFilterContainer" style="margin-bottom: 20px; display: none;">
                        <label for="projectFilter" style="font-family: 'Artifact Elements', Arial, sans-serif; font-size: 14px; color: #333; margin-right: 10px;">Filter projects:</label>
                        <input 
                            type="text" 
                            id="projectFilter" 
                            placeholder="Type to filter projects by name..." 
                            style="
                                padding: 8px 12px;
                                border: 1px solid #ccc;
                                border-radius: 4px;
                                font-family: 'Artifact Elements', Arial, sans-serif;
                                font-size: 14px;
                                width: 300px;
                                outline: none;
                            "
                            oninput="filterProjects()"
                        />
                        <span id="projectCount" style="margin-left: 15px; font-family: 'Artifact Elements', Arial, sans-serif; font-size: 14px; color: #666;"></span>
                    </div>
                    
                    <!-- Button Explanations -->
                    <div id="buttonExplanations" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; display: none;">
                        <p style="margin: 0; font-family: 'Artifact Elements', Arial, sans-serif; font-size: 14px; color: #495057; line-height: 1.6;">
                            <strong>Update from the Users Main List</strong> - synchronize project users with the Users Main List.
                        </p>
                    </div>
                </div>
                <div id="projectsList"></div>
            </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>

    <script>
        // ========================================================================
        // GLOBAL VARIABLES
        // ========================================================================
        
        // Credentials Modal Management
        let credentialsModal = null;
        
        // APS Credentials (loaded from encrypted storage)
        let CLIENT_ID = '';
        let CLIENT_SECRET = '';
        
        // Firebase variables (initialized below)
        let auth = null;
        let db = null;
        
        // ========================================================================
        // AUTHENTICATION AND SESSION MANAGEMENT
        // ========================================================================
        
        // DEMO MODE: Check if running in demo mode (for UI testing without Firebase)
        const isDemoMode = window.location.search.includes('demo=true') || 
                          localStorage.getItem('DEMO_MODE') === 'true';
        
        if (isDemoMode) {
            console.log('üé® DEMO MODE: Authentication bypassed for UI testing');
            localStorage.setItem('DEMO_MODE', 'true');
            // Skip Firebase initialization in demo mode
            displayDemoInfo();
        } else {
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        }
        
        let currentUser = null;
        let authToken = null;
        
        // Security: HTML escape function to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Security: Token manager (reduces exposure on window object)
        window.getAuthToken = function() {
            return authToken;
        };
        // Keep window.authToken for backward compatibility, but log warning
        Object.defineProperty(window, 'authToken', {
            get: function() {
                console.warn('‚ö†Ô∏è Accessing window.authToken directly - use getAuthToken() instead');
                return authToken;
            },
            set: function(value) {
                authToken = value;
            }
        });
        
        // Check authentication status on page load
        if (!isDemoMode) {
            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    // User not logged in - redirect to login immediately
                    window.location.replace('login.html');
                    return;
                }
            
            // Check if email is verified
            if (!user.emailVerified) {
                alert('Please verify your email before using this tool.');
                await auth.signOut();
                window.location.replace('login.html');
                return;
            }
            
            try {
                // Check if user is admin first
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                const isAdmin = adminDoc.exists;
                
                if (isAdmin) {
                    // Admin users don't need license validation
                    authToken = await user.getIdToken();
                    window.authToken = authToken; // Expose globally for user-table.js
                    currentUser = user;
                    
                    // Load encrypted credentials from database
                    await loadEncryptedCredentials();
                    
                    // Show admin info in UI
                    displayLicenseInfo(null, user.email, true);
                    
                    // Add logout button
                    addLogoutButton();
                    
                    // Remove loading overlay - auth verified
                    document.body.classList.add('auth-verified');
                    
                    console.log('‚úì Admin authenticated successfully');
                } else {
                    // Regular user - check license
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                        alert('User data not found. Please contact support.');
                        await auth.signOut();
                        window.location.replace('login.html');
                        return;
                    }
                    
                    const userData = userDoc.data();
                    
                    // Check license expiry
                    const licenseExpiry = userData.licenseExpiry ? userData.licenseExpiry.toDate() : null;
                    if (!licenseExpiry || licenseExpiry < new Date()) {
                        alert('Your license has expired. Please renew to continue.');
                        await auth.signOut();
                        window.location.replace('purchase.html');
                        return;
                    }
                    
                    // Get Firebase authentication token for API calls
                    authToken = await user.getIdToken();
                    window.authToken = authToken; // Expose globally for user-table.js
                    currentUser = user;
                    
                    // Load encrypted credentials from database
                    await loadEncryptedCredentials();
                    
                    // Show license info in UI
                    displayLicenseInfo(licenseExpiry, user.email);
                    
                    // Add logout button
                    addLogoutButton();
                    
                    // Remove loading overlay - auth verified
                    document.body.classList.add('auth-verified');
                    
                    console.log('‚úì User authenticated successfully');
                    console.log('‚úì License valid until:', licenseExpiry.toLocaleDateString());
                }
                
            } catch (error) {
                console.error('Error loading user data:', error);
                alert('Error loading user data. Please try logging in again.');
                await auth.signOut();
                window.location.replace('login.html');
            }
        });
        }
        
        // Demo mode info display
        function displayDemoInfo() {
            const demoInfoHTML = `
                <div id="demoInfo" style="position: fixed; top: 10px; right: 10px; background: #fff3cd; padding: 10px 15px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 12px; z-index: 10000; border: 2px solid #ffc107;">
                    <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">üé® DEMO MODE</div>
                    <div style="color: #856404; font-size: 11px;">Authentication bypassed for UI preview</div>
                    <div style="color: #856404; font-size: 11px; margin-top: 5px;">
                        <a href="?demo=false" onclick="localStorage.removeItem('DEMO_MODE')" style="color: #0696D7;">Exit Demo</a>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', demoInfoHTML);
        }
        
        // Load encrypted credentials from server
        async function loadEncryptedCredentials() {
            try {
                // Load from encrypted Firebase storage (authoritative source)
                const response = await fetch(`${window.location.origin}/load-credentials`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.clientId && data.clientSecret) {
                        CLIENT_ID = data.clientId;
                        CLIENT_SECRET = data.clientSecret;
                        console.log('‚úì Credentials loaded from secure encrypted storage');
                    } else {
                        // No credentials in Firebase - clear any old localStorage data
                        CLIENT_ID = '';
                        CLIENT_SECRET = '';
                        localStorage.removeItem('APS_CLIENT_ID');
                        localStorage.removeItem('APS_CLIENT_SECRET');
                        console.log('‚Ñπ No credentials saved yet - please enter them');
                    }
                } else {
                    // Clear localStorage on error
                    CLIENT_ID = '';
                    CLIENT_SECRET = '';
                    localStorage.removeItem('APS_CLIENT_ID');
                    localStorage.removeItem('APS_CLIENT_SECRET');
                }
            } catch (error) {
                console.error('Error loading encrypted credentials:', error);
                // Clear localStorage on error
                CLIENT_ID = '';
                CLIENT_SECRET = '';
                localStorage.removeItem('APS_CLIENT_ID');
                localStorage.removeItem('APS_CLIENT_SECRET');
            }
        }
        
        // Save encrypted credentials to server
        async function saveEncryptedCredentials(clientId, clientSecret) {
            try {
                const response = await fetch(`${window.location.origin}/save-credentials`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ clientId, clientSecret })
                });
                
                if (response.ok) {
                    console.log('‚úì Credentials saved to secure storage');
                    return true;
                } else {
                    const error = await response.json();
                    console.error('Error saving credentials:', error);
                    return false;
                }
            } catch (error) {
                console.error('Error saving encrypted credentials:', error);
                return false;
            }
        }
        
        // Display license info in UI
        function displayLicenseInfo(expiryDate, email, isAdmin = false) {
            // License info display disabled - keeping function for backward compatibility
            console.log('‚ÑπÔ∏è License info display disabled');
        }
        
        // Add logout button
        function addLogoutButton() {
            // Logout button display disabled - keeping function for backward compatibility
            console.log('‚ÑπÔ∏è Logout button display disabled');
        }
        
        // Handle logout
        async function handleLogout() {
            try {
                await auth.signOut();
                localStorage.clear(); // Clear all stored data
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error logging out. Please try again.');
            }
        }
        
        // ========================================================================
        // ORIGINAL APPLICATION CODE
        // ========================================================================
        
        // Store the original hubs data globally and current access token
        var currentAccessToken = null; // Make it global
        let originalHubsData = null;
        // Use dynamic redirect URI based on current location (works on localhost and cloud)
        const REDIRECT_URI = `${window.location.origin}/index.html`;

        // Legacy function - now loads from encrypted storage instead of localStorage
        function loadCredentials() {
            // This will be called by loadEncryptedCredentials() automatically
            // Keep for backwards compatibility but functionality moved to Firebase
            return;
            try {
                const storedClientId = localStorage.getItem('APS_CLIENT_ID');
                const storedClientSecret = localStorage.getItem('APS_CLIENT_SECRET');
                
                if (storedClientId && storedClientSecret) {
                    CLIENT_ID = storedClientId;
                    CLIENT_SECRET = storedClientSecret;
                    console.log('Credentials loaded from browser storage');
                } else {
                    console.warn('No credentials found in browser storage');
                }
            } catch (error) {
                console.error('Error loading credentials:', error);
                CLIENT_ID = '';
                CLIENT_SECRET = '';
            }
        }
        
        // Authentication URLs
        const AUTH_URL = 'https://developer.api.autodesk.com/authentication/v2/authorize';
        const TOKEN_URL = 'https://developer.api.autodesk.com/authentication/v2/token';

        function createCredentialsModal() {
            if (credentialsModal) return;

            const modalHTML = `
                <div id="credentialsModal" class="credentials-modal" style="display: none;">
                    <div class="credentials-modal-content">
                        <div class="credentials-modal-header">
                            <h3>Enter your APS application Client Credentials</h3>
                            <span class="credentials-modal-close">&times;</span>
                        </div>
                        <div class="credentials-modal-body">
                            <div style="margin-bottom: 15px;">
                                <label for="clientIdInput" style="display: block; margin-bottom: 5px; font-weight: bold; font-family: 'Artifact Elements', Arial, sans-serif;">Client ID:</label>
                                <input type="text" id="clientIdInput" placeholder="Enter your APS Client ID" 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: 'Artifact Elements', Arial, sans-serif;" />
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label for="clientSecretInput" style="display: block; margin-bottom: 5px; font-weight: bold; font-family: 'Artifact Elements', Arial, sans-serif;">Client Secret:</label>
                                <input type="password" id="clientSecretInput" placeholder="Enter your APS Client Secret" 
                                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: 'Artifact Elements', Arial, sans-serif;" />
                                <small style="color: #666; font-style: italic; font-family: 'Artifact Elements', Arial, sans-serif;">Secret will be hidden for security</small>
                            </div>
                            <div style="margin-bottom: 20px; padding: 12px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 13px; color: #495057; font-family: 'Artifact Elements', Arial, sans-serif;">
                                In your app General Settings add the Callback URL: <strong>https://usermgt.digibuild.ch/index.html</strong>
                            </div>
                            <div style="margin-bottom: 20px; text-align: center;">
                                <img src="APS General Settings.png" alt="APS General Settings" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: space-between; align-items: center;">
                                <button onclick="saveCredentials()">
                                    Save Credentials
                                </button>
                                <button onclick="openApsGuide()">
                                    How to create an APS app
                                </button>
                            </div>
                            <div id="credentialsMessage" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
                        </div>
                    </div>
                </div>
            `;

            const styles = `
                <style>
                    .credentials-modal {
                        position: fixed;
                        z-index: 2000;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0,0,0,0.5);
                    }

                    .credentials-modal-content {
                        background-color: #fefefe;
                        margin: 10% auto;
                        padding: 0;
                        border: 1px solid #888;
                        width: 90%;
                        max-width: 500px;
                        border-radius: 8px;
                        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                        font-family: 'Artifact Elements', Arial, sans-serif;
                    }

                    .credentials-modal-header {
                        padding: 15px 20px;
                        background-color: #f8f9fa;
                        border-bottom: 1px solid #ddd;
                        border-radius: 8px 8px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .credentials-modal-header h3 {
                        margin: 0;
                        color: #333;
                        font-family: 'Artifact Elements', Arial, sans-serif;
                    }

                    .credentials-modal-close {
                        color: #aaa;
                        font-size: 28px;
                        font-weight: bold;
                        cursor: pointer;
                        line-height: 1;
                        font-family: 'Artifact Elements', Arial, sans-serif;
                    }

                    .credentials-modal-close:hover,
                    .credentials-modal-close:focus {
                        color: #000;
                    }

                    .credentials-modal-body {
                        padding: 20px;
                        font-family: 'Artifact Elements', Arial, sans-serif;
                    }
                </style>
            `;

            document.head.insertAdjacentHTML('beforeend', styles);
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            credentialsModal = document.getElementById('credentialsModal');
            setupCredentialsModalEvents();
        }

        function setupCredentialsModalEvents() {
            const closeBtn = document.querySelector('.credentials-modal-close');

            closeBtn.addEventListener('click', () => {
                closeCredentialsModal();
            });

            // Removed: Close modal when clicking outside
            // Modal now only closes with the "X" button or Escape key

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && credentialsModal && credentialsModal.style.display === 'block') {
                    closeCredentialsModal();
                }
            });

            // Add Enter key support for inputs
            const clientIdInput = document.getElementById('clientIdInput');
            const clientSecretInput = document.getElementById('clientSecretInput');
            
            [clientIdInput, clientSecretInput].forEach(input => {
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        saveCredentials();
                    }
                });
            });
        }

        function showCredentialsModal() {
            console.log('showCredentialsModal called');
            try {
                createCredentialsModal();
                console.log('credentialsModal:', credentialsModal);
                
                // Pre-fill with current values
                document.getElementById('clientIdInput').value = CLIENT_ID || '';
                document.getElementById('clientSecretInput').value = CLIENT_SECRET || '';
                
                credentialsModal.style.display = 'block';
                document.getElementById('clientIdInput').focus();
                console.log('Modal displayed');
            } catch (error) {
                console.error('Error showing credentials modal:', error);
                alert('Error opening credentials modal. Check console for details.');
            }
        }

        function closeCredentialsModal() {
            if (credentialsModal) {
                credentialsModal.style.display = 'none';
                document.getElementById('credentialsMessage').style.display = 'none';
            }
        }

        async function saveCredentials() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            const clientSecret = document.getElementById('clientSecretInput').value.trim();
            const messageDiv = document.getElementById('credentialsMessage');

            if (!clientId || !clientSecret) {
                messageDiv.textContent = 'Both Client ID and Client Secret are required.';
                messageDiv.style.backgroundColor = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.style.border = '1px solid #f5c6cb';
                messageDiv.style.display = 'block';
                return;
            }

            try {
                // Show saving message
                messageDiv.textContent = 'Saving credentials securely...';
                messageDiv.style.backgroundColor = '#d1ecf1';
                messageDiv.style.color = '#0c5460';
                messageDiv.style.border = '1px solid #bee5eb';
                messageDiv.style.display = 'block';
                
                // Save to encrypted server storage (primary)
                const saved = await saveEncryptedCredentials(clientId, clientSecret);
                
                if (saved) {
                    // Update global variables
                    CLIENT_ID = clientId;
                    CLIENT_SECRET = clientSecret;

                    // Show success message
                    messageDiv.textContent = '‚úì Credentials saved securely! You can now login with Autodesk.';
                    messageDiv.style.backgroundColor = '#d4edda';
                    messageDiv.style.color = '#155724';
                    messageDiv.style.border = '1px solid #c3e6cb';
                    messageDiv.style.display = 'block';

                    console.log('Credentials saved to encrypted storage');

                    // Auto-close after 2 seconds
                    setTimeout(() => {
                        closeCredentialsModal();
                    }, 2000);
                } else {
                    throw new Error('Failed to save credentials to server');
                }
            } catch (error) {
                console.error('Error saving credentials:', error);
                messageDiv.textContent = `Error saving credentials: ${error.message}`;
                messageDiv.style.backgroundColor = '#f8d7da';
                messageDiv.style.color = '#721c24';
                messageDiv.style.border = '1px solid #f5c6cb';
                messageDiv.style.display = 'block';
            }
        }

        function openApsGuide() {
            window.open('https://aps.autodesk.com/en/docs/oauth/v2/tutorials/create-app/', '_blank');
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Function to handle logout
        async function logout() {
            // Clear current session data
            currentAccessToken = null;
            originalHubsData = null;
            
            // Sign out from Firebase if authenticated
            if (auth && auth.currentUser) {
                await auth.signOut();
            }
            
            // Clear local storage
            localStorage.clear();
            
            console.log('User logged out successfully');
            
            // Redirect to login page immediately (this clears OAuth codes from URL)
            window.location.replace('login.html');
        }

        // Function to handle login
        function login() {
            // Check if credentials are configured
            if (!CLIENT_ID || !CLIENT_SECRET) {
                showError('Client credentials not configured. Please click "Enter Client Credentials" first.');
                return;
            }
            
            // Updated scopes to include construction admin access
            const scopes = encodeURIComponent('data:read data:write data:create account:read account:write user:read');
            const state = Math.random().toString(36).substring(7);
            const authUrl = `${AUTH_URL}?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${scopes}&state=${state}`;
            
            // Debug information
            console.log('Auth URL:', authUrl);
            console.log('Client ID:', CLIENT_ID);
            console.log('Redirect URI:', REDIRECT_URI);
            console.log('Scopes:', scopes);
            
            window.location.href = authUrl;
        }

        // Function to get access token from code
        async function getAccessToken(code) {
            const data = new URLSearchParams();
            data.append('client_id', CLIENT_ID);
            data.append('client_secret', CLIENT_SECRET);
            data.append('grant_type', 'authorization_code');
            data.append('code', code);
            data.append('redirect_uri', REDIRECT_URI);

            try {
                const response = await fetch(TOKEN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: data
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Token error: ${errorData.error_description || 'Unknown error'}`);
                }
                
                const tokenData = await response.json();
                currentAccessToken = tokenData.access_token; // Store the access token
                return tokenData.access_token;
            } catch (error) {
                console.error('Error getting access token:', error);
                showError(`Authentication error: ${error.message}`);
                return null;
            }
        }

        // Function to handle hub selection
        async function selectHub(hubId, hubName, hubRegion) {
            const projectsHeader = document.getElementById('projectsHeader');
            const selectedHubTitle = document.getElementById('selectedHubTitle');
            const projectsList = document.getElementById('projectsList');
            const viewAccountUsersBtn = document.getElementById('viewAccountUsersBtn');
            
            // Update header
            selectedHubTitle.textContent = `Projects in ${hubName}`;
            projectsHeader.style.display = 'block';
            
            // Set up the View Account Users button
            viewAccountUsersBtn.onclick = () => showAccountUsers(hubId, hubName, currentAccessToken);
            viewAccountUsersBtn.style.display = 'block';
            
            // Show loading message
            projectsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading projects...</div>';
            
            try {
                // Get 2-legged token for Construction Admin API
                const twoLeggedToken = await get2LeggedToken();
                
                // Fetch projects using Construction Admin API
                const projects = await fetchAllProjects(hubId, twoLeggedToken);
                
                // Filter only ACC projects (platform: "acc")
                const accProjects = projects.filter(project => project.platform === 'acc');
                
                displayProjects(accProjects, hubName, hubId);
                
            } catch (error) {
                console.error('Error loading projects:', error);
                projectsList.innerHTML = `<div style="color: red; text-align: center; padding: 40px;">Error loading projects: ${escapeHtml(error.message)}</div>`;
            }
        }

        // Function to fetch all projects with pagination
        async function fetchAllProjects(accountId, accessToken) {
            let allProjects = [];
            let offset = 0;
            const limit = 100;
            let hasMoreData = true;

            while (hasMoreData) {
                const queryParams = new URLSearchParams({
                    'limit': limit.toString(),
                    'offset': offset.toString()
                });

                const apiUrl = `https://developer.api.autodesk.com/construction/admin/v1/accounts/${accountId}/projects?${queryParams}`;
                console.log(`Fetching projects: ${apiUrl}`);

                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                        console.log('Error response:', errorData);
                    } catch (parseError) {
                        const textError = await response.text();
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${textError}`);
                    }
                    
                    const errorMessage = errorData.message || 
                                       errorData.error || 
                                       errorData.error_description || 
                                       `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMessage);
                }

                const projectsData = await response.json();
                console.log(`Fetched ${projectsData.results?.length || 0} projects at offset ${offset}`);

                if (projectsData.results && projectsData.results.length > 0) {
                    allProjects = allProjects.concat(projectsData.results);

                    // Update loading message with progress
                    const projectsList = document.getElementById('projectsList');
                    const totalExpected = projectsData.pagination ? projectsData.pagination.totalResults : 'unknown';
                    projectsList.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">Loading projects... Found ${allProjects.length}${totalExpected !== 'unknown' ? ` of ${totalExpected}` : ''} projects so far.</div>`;

                    // Check pagination
                    if (projectsData.pagination && projectsData.pagination.totalResults) {
                        if (allProjects.length >= projectsData.pagination.totalResults) {
                            hasMoreData = false;
                        } else {
                            offset += limit;
                        }
                    } else {
                        if (projectsData.results.length < limit) {
                            hasMoreData = false;
                        } else {
                            offset += limit;
                        }
                    }
                } else {
                    hasMoreData = false;
                }

                // Safety check
                if (offset > 10000) {
                    console.warn('Stopping at 10,000 projects for safety');
                    hasMoreData = false;
                }
            }

            return allProjects;
        }

        // Function to display projects
        function displayProjects(projects, hubName, hubId) {
            const projectsList = document.getElementById('projectsList');
            const projectFilterContainer = document.getElementById('projectFilterContainer');
            const projectFilter = document.getElementById('projectFilter');
            const buttonExplanations = document.getElementById('buttonExplanations');
            
            // Store original projects data globally for filtering
            window.originalProjectsData = projects;
            window.currentHubName = hubName;
            window.currentHubId = hubId;
            
            // Show filter container, button explanations, and clear filter
            projectFilterContainer.style.display = 'block';
            buttonExplanations.style.display = 'block';
            projectFilter.value = '';
            
            if (projects && projects.length > 0) {
                renderProjectsList(projects);
                updateProjectCount(projects.length, projects.length);
            } else {
                projectsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No ACC projects found in this hub.</div>';
                updateProjectCount(0, 0);
            }
        }

        // Function to render the projects list
        function renderProjectsList(projects) {
            const projectsList = document.getElementById('projectsList');
            
            if (projects && projects.length > 0) {
                const projectsHtml = projects.map(project => `
                    <div class="project-item" style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #fafafa;">
                        <div style="margin-bottom: 15px;">
                            <strong style="font-size: 16px; color: #333;">${project.name}</strong>
                        </div>
                        <div style="display: flex; gap: 10px; flex-direction: column;">
                            <div style="display:flex; gap:10px;">
                                <button class="project-btn project-btn-update" onclick="updateProjectUsersFromMainList('${project.id}', window.currentHubId, currentAccessToken, 'projectProgress-${project.id}')">
                                    Update from the Users Main List
                                </button>
                                <button class="project-btn project-btn-update" onclick="showProjectUsers('${project.id}', '${project.name.replace(/'/g, "\\'")}', currentAccessToken)">
                                    View Project Users
                                </button>
                                <button class="project-btn project-btn-update" onclick="showFoldersModal('${project.id}', '${project.name.replace(/'/g, "\\'")}', window.currentHubId, currentAccessToken)">
                                    Manage Access to Folders
                                </button>
                            </div>

                            <!-- Per-project progress indicator -->
                            <div class="project-progress" id="projectProgress-${project.id}" style="display:none; margin-top:8px;">
                                <div style="width:100%; background:#eee; border-radius:6px; height:10px; overflow:hidden;">
                                    <div id="projectProgressBar-${project.id}" style="width:0%;height:10px;background:#0696D7;border-radius:6px;"></div>
                                </div>
                                <div id="projectProgressText-${project.id}" style="font-size:12px;color:#666;margin-top:6px;"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
                projectsList.innerHTML = projectsHtml;
            } else {
                projectsList.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No projects match your filter.</div>';
            }
        }

        // Function to update project count display
        function updateProjectCount(showing, total) {
            const projectCount = document.getElementById('projectCount');
            if (showing === total) {
                projectCount.textContent = `Showing ${total} project${total !== 1 ? 's' : ''}`;
            } else {
                projectCount.textContent = `Showing ${showing} of ${total} project${total !== 1 ? 's' : ''}`;
            }
        }

        // Function to filter projects
        function filterProjects() {
            if (!window.originalProjectsData) return;

            const filterText = document.getElementById('projectFilter').value.toLowerCase();
            
            // If filter is empty, show all projects
            if (!filterText.trim()) {
                renderProjectsList(window.originalProjectsData);
                updateProjectCount(window.originalProjectsData.length, window.originalProjectsData.length);
                return;
            }

            // Filter projects by name (case-insensitive)
            const filteredProjects = window.originalProjectsData.filter(project => 
                project.name.toLowerCase().includes(filterText)
            );

            renderProjectsList(filteredProjects);
            updateProjectCount(filteredProjects.length, window.originalProjectsData.length);
        }

        // Function to filter hubs
        function filterHubs() {
            if (!originalHubsData) return;

            const filterText = document.getElementById('hubFilter').value.toLowerCase();
            
            // First filter to only BIM 360 Account hubs, then apply text filter
            let hubsToFilter = originalHubsData.data.filter(hub => {
                const extensionType = hub.attributes?.extension?.type;
                return extensionType === 'hubs:autodesk.bim360:Account';
            });
            
            // If text filter is provided, apply it
            if (filterText.trim()) {
                hubsToFilter = hubsToFilter.filter(hub => 
                    hub.attributes.name.toLowerCase().includes(filterText) ||
                    hub.attributes.region.toLowerCase().includes(filterText)
                );
            }

            // Create filtered data structure
            const filteredData = {
                ...originalHubsData,
                data: hubsToFilter
            };

            displayHubs(filteredData);
        }

        // Function to show all hubs
        function showAllHubs() {
            if (originalHubsData) {
                document.getElementById('hubFilter').value = '';
                displayHubs(originalHubsData);
            }
        }

        // Add real-time filtering on input
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const hubFilterInput = document.getElementById('hubFilter');
                if (hubFilterInput) {
                    hubFilterInput.addEventListener('input', filterHubs);
                    hubFilterInput.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter') {
                            filterHubs();
                        }
                    });
                }
            }, 100);
        });

        // Function to display hubs in the left panel
        function displayHubs(hubsData) {
            console.log('Displaying hubs:', hubsData); // Debug log
            const hubsList = document.getElementById('hubsList');
            
            if (!hubsData || !hubsData.data || hubsData.data.length === 0) {
                hubsList.innerHTML = '<div class="no-results">No hubs found</div>';
                console.log('No hubs data available'); // Debug log
                return;
            }

            // Additional client-side filter to ensure only BIM 360 Account hubs
            const bim360Hubs = hubsData.data.filter(hub => {
                const extensionType = hub.attributes?.extension?.type;
                return extensionType === 'hubs:autodesk.bim360:Account';
            });

            console.log(`Filtered to ${bim360Hubs.length} BIM 360 Account hubs from ${hubsData.data.length} total hubs`);

            if (bim360Hubs.length === 0) {
                hubsList.innerHTML = '<div class="no-results">No BIM 360 Account hubs found</div>';
                return;
            }

            let hubsHTML = '';
            bim360Hubs.forEach(hub => {
                const hubName = hub.attributes.name;
                const region = hub.attributes.region;
                const hubId = hub.id;
                
                hubsHTML += `
                    <div class="hub-item" onclick="selectHub('${hubId}', '${hubName}', '${region}')">
                        <span class="hub-name">${hubName}</span>
                        <span class="hub-region">${region}</span>
                    </div>
                `;
            });

            console.log(`Displaying ${hubsData.data.length} hubs`); // Debug log
            hubsList.innerHTML = hubsHTML;
        }

        // Function to get hubs data
        async function getHubs(accessToken) {
            try {
                // Show content and hide login
                document.getElementById('login').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                // Add filter to only show BIM 360 Account hubs
                const response = await fetch('https://developer.api.autodesk.com/project/v1/hubs?filter[extension.type]=hubs:autodesk.bim360:Account', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${errorData.message || 'Unknown error'}`);
                }
                
                const hubsData = await response.json();
                originalHubsData = hubsData; // Store the original data
                displayHubs(hubsData);
            } catch (error) {
                console.error('Error getting hubs:', error);
                showError(`Error loading hubs: ${error.message}`);
            }
        }

        // Check for authorization code in URL
        window.onload = async function() {
            // Wait a bit for Firebase auth and credentials to load
            // The auth.onAuthStateChanged will load credentials
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            if (error) {
                showError(`Authentication error: ${errorDescription || error}`);
                return;
            }
            
            if (code) {
                // Wait for credentials to be loaded (max 5 seconds)
                let attempts = 0;
                while ((!CLIENT_ID || !CLIENT_SECRET) && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!CLIENT_ID || !CLIENT_SECRET) {
                    showError('Client credentials not configured. Please enter your APS credentials first.');
                    return;
                }
                
                const accessToken = await getAccessToken(code);
                if (accessToken) {
                    await getHubs(accessToken);
                }
            }
        };

        // Account Users Management - Inline implementation to avoid caching issues
        let accountUsersModal = null;

        function createAccountUsersModal() {
            if (accountUsersModal) return;

            const modalHTML = `
                <div id="accountUsersModal" class="account-users-modal" style="display: none;">
                    <div class="account-users-modal-content">
                        <div class="account-users-modal-header">
                            <h3 id="accountModalTitle">Account Users</h3>
                            <span class="account-users-modal-close">&times;</span>
                        </div>
                        <div class="account-users-modal-body">
                            <div id="accountUsersLoadingMessage">Loading users...</div>
                            <div id="accountUsersTableContainer" style="display: none;">
                                <table id="accountUsersTable">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
                                            <th>Default Role</th>
                                            <th>Company</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accountUsersTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div id="accountUsersErrorMessage" style="display: none; color: red;"></div>
                        </div>
                    </div>
                </div>
            `;

            const styles = `
                <style>
                    .account-users-modal {
                        position: fixed;
                        z-index: 1001;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0,0,0,0.5);
                    }

                    .account-users-modal-content {
                        background-color: #fefefe;
                        margin: 3% auto;
                        padding: 0;
                        border: 1px solid #888;
                        width: 90%;
                        max-width: 1000px;
                        border-radius: 8px;
                        max-height: 85vh;
                        display: flex;
                        flex-direction: column;
                    }

                    .account-users-modal-header {
                        padding: 15px 20px;
                        background-color: #e8f4f8;
                        border-bottom: 1px solid #ddd;
                        border-radius: 8px 8px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .account-users-modal-header h3 {
                        margin: 0;
                        color: #333;
                    }

                    .account-users-modal-close {
                        color: #aaa;
                        font-size: 28px;
                        font-weight: bold;
                        cursor: pointer;
                        line-height: 1;
                    }

                    .account-users-modal-close:hover,
                    .account-users-modal-close:focus {
                        color: #000;
                    }

                    .account-users-modal-body {
                        padding: 20px;
                        flex-grow: 1;
                        overflow-y: auto;
                    }

                    #accountUsersTable {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 10px;
                    }

                    #accountUsersTable th,
                    #accountUsersTable td {
                        border: 1px solid #ddd;
                        padding: 12px;
                        text-align: left;
                    }

                    #accountUsersTable th {
                        background-color: #f8f9fa;
                        font-weight: bold;
                        position: sticky;
                        top: 0;
                    }

                    #accountUsersTable tr:nth-child(even) {
                        background-color: #f9f9f9;
                    }

                    #accountUsersTable tr:hover {
                        background-color: #f0f8ff;
                    }

                    #accountUsersLoadingMessage {
                        text-align: center;
                        padding: 40px;
                        font-size: 16px;
                        color: #666;
                    }
                </style>
            `;

            document.head.insertAdjacentHTML('beforeend', styles);
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            accountUsersModal = document.getElementById('accountUsersModal');
            setupAccountModalEvents();
        }

        function setupAccountModalEvents() {
            const closeBtn = document.querySelector('.account-users-modal-close');

            closeBtn.addEventListener('click', () => {
                closeAccountUsersModal();
            });

            window.addEventListener('click', (event) => {
                if (event.target === accountUsersModal) {
                    closeAccountUsersModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && accountUsersModal && accountUsersModal.style.display === 'block') {
                    closeAccountUsersModal();
                }
            });
        }

        function closeAccountUsersModal() {
            if (accountUsersModal) {
                accountUsersModal.style.display = 'none';
                document.getElementById('accountUsersTableBody').innerHTML = '';
                document.getElementById('accountUsersLoadingMessage').textContent = 'Loading users...';
                document.getElementById('accountUsersLoadingMessage').style.display = 'block';
                document.getElementById('accountUsersTableContainer').style.display = 'none';
                document.getElementById('accountUsersErrorMessage').style.display = 'none';
            }
        }

        // Function for "Update from the Users Main List" button
        async function updateProjectUsersFromMainList(projectId, accountId, accessToken, progressId) {
            const progressEl = document.getElementById(progressId);
            const progressBar = document.getElementById(`${progressId.replace('projectProgress-','projectProgressBar-')}`) || null;
            const progressText = document.getElementById(`${progressId.replace('projectProgress-','projectProgressText-')}`) || null;
            if (progressEl) progressEl.style.display = 'block';
            if (progressBar) progressBar.style.width = '0%';
            if (progressText) progressText.textContent = 'Loading data...';
            
            try {
                // Load user permissions from Firestore
                if (progressText) progressText.textContent = 'Loading Users Main List...';
                
                // Fetch from server API with authentication
                const importResponse = await fetch(`${window.location.origin}/load`, {
                    headers: isDemoMode ? {} : {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!importResponse.ok) {
                    if (importResponse.status === 401) {
                        alert('Session expired. Please login again.');
                        if (!isDemoMode) await auth.signOut();
                        window.location.href = 'login.html';
                        return;
                    }
                    throw new Error('Failed to load user permissions');
                }
                
                const importData = await importResponse.json();
                const importUsers = importData.users || [];
                console.log(`Loaded ${importUsers.length} users from Firestore`);
                
                // Fetch project users
                if (progressText) progressText.textContent = 'Fetching project users...';
                const projectUsers = await fetchAllProjectUsers(projectId, accessToken);
                console.log(`Fetched ${projectUsers.length} project users`);
                
                // Build email maps for quick lookup
                const importEmailMap = new Map();
                importUsers.forEach(user => {
                    if (user.email) importEmailMap.set(user.email.toLowerCase(), user);
                });
                
                const projectEmailMap = new Map();
                projectUsers.forEach(user => {
                    if (user.email) projectEmailMap.set(user.email.toLowerCase(), user);
                });
                
                // Build 3 lists
                const listToPatch = []; // Users in both (to update)
                const listToPost = [];  // Users in JSON but not in project (to add)
                const listToDelete = []; // Users in project but not in JSON (to delete)
                
                console.log('Import users emails:', Array.from(importEmailMap.keys()));
                console.log('Project users emails:', Array.from(projectEmailMap.keys()));
                
                // List 1 & 2: Check import users
                importUsers.forEach(importUser => {
                    if (!importUser.email) {
                        console.warn('Skipping import user with no email:', importUser);
                        return;
                    }
                    const email = importUser.email.toLowerCase();
                    
                    if (projectEmailMap.has(email)) {
                        // User exists in both ‚Üí PATCH
                        console.log(`‚úì PATCH: ${importUser.email} (exists in both)`);
                        listToPatch.push({
                            email: importUser.email,
                            projectUserId: projectEmailMap.get(email).id
                        });
                    } else {
                        // User in JSON but not in project ‚Üí POST
                        console.log(`+ POST: ${importUser.email} (only in JSON)`);
                        listToPost.push({
                            email: importUser.email
                        });
                    }
                });
                
                // List 3: Check project users not in import
                projectUsers.forEach(projectUser => {
                    if (!projectUser.email) {
                        console.warn('Skipping project user with no email:', projectUser);
                        return;
                    }
                    const email = projectUser.email.toLowerCase();
                    
                    if (!importEmailMap.has(email)) {
                        // User in project but not in JSON ‚Üí DELETE
                        console.log(`- DELETE: ${projectUser.email} (only in project)`);
                        listToDelete.push({
                            email: projectUser.email,
                            id: projectUser.id
                        });
                    }
                });
                
                console.log('Analysis complete:');
                console.log(`- To PATCH (update): ${listToPatch.length}`, listToPatch);
                console.log(`- To POST (add): ${listToPost.length}`, listToPost);
                console.log(`- To DELETE (remove): ${listToDelete.length}`, listToDelete);
                
                // Show results in a dialog
                showUserListsDialog(listToPatch, listToPost, listToDelete, projectId, accountId, accessToken);
                
                if (progressBar) progressBar.style.width = '100%';
                if (progressText) progressText.textContent = 'Analysis complete.';
                setTimeout(() => { if (progressEl) progressEl.style.display = 'none'; }, 2500);
                
            } catch (error) {
                console.error('Error analyzing users:', error);
                if (progressText) progressText.textContent = `Error: ${error.message}`;
                alert(`Failed to analyze users: ${error.message}`);
            }
        }
        
        // Function to show the 3 lists in a dialog
        function showUserListsDialog(listToPatch, listToPost, listToDelete, projectId, accountId, accessToken) {
            // Create modal HTML
            const modalHTML = `
                <div id="userListsModal" style="position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;">
                    <div style="background-color: white; padding: 0; border-radius: 8px; width: 90%; max-width: 900px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; font-family: 'Artifact Elements', Arial, sans-serif;">User Sync Analysis</h2>
                            <span class="sync-modal-close" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; font-family: 'Artifact Elements', Arial, sans-serif;">&times;</span>
                        </div>
                        <div style="padding: 20px; overflow-y: auto; flex: 1;">
                            <div style="margin-bottom: 30px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="color: #0696D7; font-family: 'Artifact Elements', Arial, sans-serif; margin: 0;">
                                        Users to UPDATE - ${listToPatch.length}
                                    </h3>
                                    <input type="checkbox" id="enableUpdate" checked style="width: 18px; height: 18px; cursor: pointer;">
                                </div>
                                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">These users exist in both the project and Users Main List. They will be updated.</p>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9;">
                                    ${listToPatch.length > 0 ? listToPatch.map(u => `<div style="padding: 4px 0; font-family: 'Artifact Elements', Arial, sans-serif; font-size: 13px;">‚úì ${u.email}</div>`).join('') : '<div style="color: #999; font-style: italic;">No users to update</div>'}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 30px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="color: #28a745; font-family: 'Artifact Elements', Arial, sans-serif; margin: 0;">
                                        Users to ADD - ${listToPost.length}
                                    </h3>
                                    <input type="checkbox" id="enableAdd" checked style="width: 18px; height: 18px; cursor: pointer;">
                                </div>
                                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">These users exist in Users Main List but not in the project. They will be added.</p>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9;">
                                    ${listToPost.length > 0 ? listToPost.map(u => `<div style="padding: 4px 0; font-family: 'Artifact Elements', Arial, sans-serif; font-size: 13px;">+ ${u.email}</div>`).join('') : '<div style="color: #999; font-style: italic;">No users to add</div>'}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="color: #dc3545; font-family: 'Artifact Elements', Arial, sans-serif; margin: 0;">
                                        Users to DELETE - ${listToDelete.length}
                                    </h3>
                                    <input type="checkbox" id="enableDelete" checked style="width: 18px; height: 18px; cursor: pointer;">
                                </div>
                                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">These users exist in the project but not in Users Main List. They will be removed.</p>
                                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; background: #f9f9f9;">
                                    ${listToDelete.length > 0 ? listToDelete.map(u => `<div style="padding: 4px 0; font-family: 'Artifact Elements', Arial, sans-serif; font-size: 13px;">- ${u.email}</div>`).join('') : '<div style="color: #999; font-style: italic;">No users to delete</div>'}
                                </div>
                            </div>
                            
                            <!-- Results section (hidden initially) -->
                            <div id="syncResults" style="display: none; margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                                <h4 style="margin: 0 0 10px 0; font-family: 'Artifact Elements', Arial, sans-serif;">Sync completed!</h4>
                                <div id="syncResultsContent" style="font-family: 'Artifact Elements', Arial, sans-serif; font-size: 14px; line-height: 1.6;"></div>
                            </div>
                        </div>
                        <div style="padding: 20px; border-top: 1px solid #ddd; display: flex; justify-content: flex-end; gap: 10px;">
                            <button id="syncButton" style="padding: 10px 20px; background: #0696D7; color: white; border: none; border-radius: 4px; cursor: pointer; font-family: 'Artifact Elements', Arial, sans-serif;">Sync</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Add event listeners
            const closeBtn = document.querySelector('.sync-modal-close');
            if (closeBtn) {
                closeBtn.onclick = function() {
                    document.getElementById('userListsModal').remove();
                };
                
                // Add hover effect
                closeBtn.addEventListener('mouseenter', function() {
                    this.style.color = '#000';
                });
                closeBtn.addEventListener('mouseleave', function() {
                    this.style.color = '#aaa';
                });
            }
            
            // Close on Escape key
            document.addEventListener('keydown', function escapeHandler(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('userListsModal');
                    if (modal) {
                        modal.remove();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                }
            });
            
            // Add Sync button event listener
            const syncButton = document.getElementById('syncButton');
            if (syncButton) {
                syncButton.onclick = async function() {
                    await executeSyncOperations(listToPatch, listToPost, listToDelete, projectId, accountId, accessToken);
                };
            }
        }
        
        // Function to execute sync operations based on checkbox selections
        async function executeSyncOperations(listToPatch, listToPost, listToDelete, projectId, accountId, accessToken) {
            const enableUpdate = document.getElementById('enableUpdate').checked;
            const enableAdd = document.getElementById('enableAdd').checked;
            const enableDelete = document.getElementById('enableDelete').checked;
            
            console.log('Sync initiated:', { enableUpdate, enableAdd, enableDelete, projectId, accountId });
            
            if (!projectId || !accountId) {
                alert('Missing project or account ID');
                return;
            }
            
            // Disable sync button and show progress
            const syncButton = document.getElementById('syncButton');
            const originalButtonText = syncButton.textContent;
            syncButton.disabled = true;
            syncButton.style.opacity = '0.6';
            syncButton.style.cursor = 'not-allowed';
            
            try {
                // Get 2-legged token
                syncButton.textContent = 'Processing...';
                const twoLeggedToken = await get2LeggedToken();
                
                // STEP 1: Update account users first (company and role from Users Main List)
                console.log('üöÄ STEP 1: Updating account users with company and role from Users Main List');
                try {
                    const accountUpdateResult = await updateAccountUsersForAccount(accountId, {performOps: true});
                    console.log('‚úÖ Account users updated:', accountUpdateResult);
                } catch (accountError) {
                    console.error('‚ö†Ô∏è Account update failed (continuing anyway):', accountError);
                    // Continue even if account update fails - user might not have permissions
                }
                
                // STEP 2: Fetch all required data
                
                // Load user permissions from Firestore
                const importResponse = await fetch(`${window.location.origin}/load`, {
                    headers: isDemoMode ? {} : {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!importResponse.ok) {
                    throw new Error('Failed to load user permissions');
                }
                
                const importData = await importResponse.json();
                
                const [accountUsers, projectUsers] = await Promise.all([
                    accountUsersManager.fetchAllAccountUsersWith2LeggedAuth(accountId),
                    fetchAllProjectUsers(projectId, twoLeggedToken)
                ]);
                
                const importUsers = importData.users || [];
                
                // Create lookup maps
                const importEmailMap = new Map(importUsers.map(u => [u.email.toLowerCase(), u]));
                const accountEmailMap = new Map(accountUsers.map(u => [u.email.toLowerCase(), u]));
                const projectEmailMap = new Map(projectUsers.map(u => [u.email.toLowerCase(), u]));
                
                console.log('Data loaded:', {
                    importUsers: importUsers.length,
                    accountUsers: accountUsers.length,
                    projectUsers: projectUsers.length
                });
                
                let results = {
                    updated: 0,
                    added: 0,
                    deleted: 0,
                    errors: []
                };
                
                // Execute PATCH operations
                if (enableUpdate && listToPatch.length > 0) {
                    
                    for (let i = 0; i < listToPatch.length; i++) {
                        const userToPatch = listToPatch[i];
                        const email = userToPatch.email.toLowerCase();
                        
                        try {
                            syncButton.textContent = `Processing ${i + 1}/${listToPatch.length} users`;
                            
                            // Get data from all sources
                            const importUser = importEmailMap.get(email);
                            const accountUser = accountEmailMap.get(email);
                            const projectUser = projectEmailMap.get(email);
                            
                            if (!importUser || !accountUser || !projectUser) {
                                throw new Error(`Missing data for ${userToPatch.email}`);
                            }
                            
                            // Build products array from import JSON (REQUIRED)
                            const products = importUser.products.map(p => ({
                                key: p.key,
                                access: p.access
                            }));
                            
                            // Build PATCH payload - start with required field
                            const patchPayload = {
                                products: products
                            };
                            
                            // Add optional company fields if available from account user
                            if (accountUser.company_id) {
                                patchPayload.companyId = accountUser.company_id;
                            }
                            if (accountUser.company_name) {
                                patchPayload.companyName = accountUser.company_name;
                            }
                            
                            // Add optional role field if available from account user
                            if (accountUser.default_role_id) {
                                patchPayload.roleIds = [accountUser.default_role_id];
                            }
                            
                            console.log(`PATCH user ${userToPatch.email}:`, patchPayload);
                            
                            // Execute PATCH request
                            const response = await fetch(
                                `https://developer.api.autodesk.com/construction/admin/v1/projects/${projectId}/users/${projectUser.id}`,
                                {
                                    method: 'PATCH',
                                    headers: {
                                        'Authorization': `Bearer ${accessToken}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(patchPayload)
                                }
                            );
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                                throw new Error(errorData.message || `HTTP ${response.status}`);
                            }
                            
                            const result = await response.json();
                            console.log(`‚úì Updated ${userToPatch.email}:`, result);
                            results.updated++;
                            
                        } catch (error) {
                            console.error(`‚úó Failed to update ${userToPatch.email}:`, error);
                            results.errors.push(`Update failed for ${userToPatch.email}: ${error.message}`);
                        }
                        
                        // Small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // === POST Operation - Add users ===
                if (enableAdd && listToPost.length > 0) {
                    console.log('\n=== POST Operation - Adding Users ===');
                    
                    // Batch users in groups of 200 (API limit)
                    const batchSize = 200;
                    const batches = [];
                    for (let i = 0; i < listToPost.length; i += batchSize) {
                        batches.push(listToPost.slice(i, i + batchSize));
                    }
                    
                    console.log(`Processing ${listToPost.length} users in ${batches.length} batch(es)`);
                    
                    const totalToAdd = listToPost.length;
                    let processedCount = 0;
                    
                    for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
                        const batch = batches[batchIndex];
                        
                        try {
                            // Build users array for POST
                            const usersToAdd = [];
                            
                            for (const userToAdd of batch) {
                                // Get user data from import JSON (email and products are required)
                                const importUser = importEmailMap.get(userToAdd.email.toLowerCase());
                                if (!importUser || !importUser.products) {
                                    console.warn(`Skipping ${userToAdd.email}: No products data in import JSON`);
                                    results.errors.push(`Add failed for ${userToAdd.email}: No products data`);
                                    continue;
                                }
                                
                                // Build user object
                                const userPayload = {
                                    email: userToAdd.email,
                                    products: importUser.products
                                };
                                
                                // Get optional company and role from account user
                                const accountUser = accountEmailMap.get(userToAdd.email.toLowerCase());
                                if (accountUser) {
                                    if (accountUser.company_id) {
                                        userPayload.companyId = accountUser.company_id;
                                    }
                                    if (accountUser.default_role_id) {
                                        userPayload.roleIds = [accountUser.default_role_id];
                                    }
                                }
                                
                                usersToAdd.push(userPayload);
                            }
                            
                            if (usersToAdd.length === 0) {
                                console.warn(`Batch ${batchIndex + 1}: No valid users to add`);
                                continue;
                            }
                            
                            syncButton.textContent = `Processing ${processedCount + 1}-${processedCount + usersToAdd.length}/${totalToAdd} users`;
                            
                            console.log(`Batch ${batchIndex + 1}: Adding ${usersToAdd.length} users`);
                            
                            // Execute POST request
                            const postUrl = `https://developer.api.autodesk.com/construction/admin/v2/projects/${projectId}/users:import`;
                            const response = await fetch(postUrl, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ users: usersToAdd })
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                                throw new Error(errorData.message || `HTTP ${response.status}`);
                            }
                            
                            const result = await response.json();
                            console.log(`‚úì Batch ${batchIndex + 1} completed:`, result);
                            results.added += usersToAdd.length;
                            processedCount += usersToAdd.length;
                            
                        } catch (error) {
                            console.error(`‚úó Batch ${batchIndex + 1} failed:`, error);
                            results.errors.push(`Batch ${batchIndex + 1} add failed: ${error.message}`);
                        }
                        
                        // Delay between batches to avoid rate limiting
                        if (batchIndex < batches.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                }
                
                // === DELETE Operation - Remove users ===
                if (enableDelete && listToDelete.length > 0) {
                    console.log('\n=== DELETE Operation - Removing Users ===');
                    
                    for (let i = 0; i < listToDelete.length; i++) {
                        const userToDelete = listToDelete[i];
                        syncButton.textContent = `Processing ${i + 1}/${listToDelete.length} users`;
                        
                        try {
                            // Get userId from project users
                            const projectUser = projectEmailMap.get(userToDelete.email.toLowerCase());
                            if (!projectUser || !projectUser.id) {
                                console.warn(`Skipping ${userToDelete.email}: No user ID found in project`);
                                results.errors.push(`Delete failed for ${userToDelete.email}: No user ID`);
                                continue;
                            }
                            
                            console.log(`DELETE user ${userToDelete.email} (ID: ${projectUser.id})`);
                            
                            // Execute DELETE request
                            const deleteUrl = `https://developer.api.autodesk.com/construction/admin/v1/projects/${projectId}/users/${projectUser.id}`;
                            const response = await fetch(deleteUrl, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${accessToken}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                                throw new Error(errorData.message || `HTTP ${response.status}`);
                            }
                            
                            console.log(`‚úì Deleted ${userToDelete.email}`);
                            results.deleted++;
                            
                        } catch (error) {
                            console.error(`‚úó Failed to delete ${userToDelete.email}:`, error);
                            results.errors.push(`Delete failed for ${userToDelete.email}: ${error.message}`);
                        }
                        
                        // Small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                // Show results in modal
                syncButton.textContent = 'Sync Complete!';
                
                // Build summary HTML
                let summaryHTML = '';
                if (enableUpdate) summaryHTML += `Updated: ${results.updated}/${listToPatch.length}<br>`;
                if (enableAdd) summaryHTML += `Added: ${results.added}/${listToPost.length}<br>`;
                if (enableDelete) summaryHTML += `Deleted: ${results.deleted}/${listToDelete.length}<br>`;
                
                if (results.errors.length > 0) {
                    summaryHTML += `<br><strong style="color: #dc3545;">Errors (${results.errors.length}):</strong><br>`;
                    summaryHTML += results.errors.slice(0, 5).map(err => `<span style="color: #666; font-size: 12px;">‚Ä¢ ${err}</span>`).join('<br>');
                    if (results.errors.length > 5) {
                        summaryHTML += `<br><span style="color: #666; font-size: 12px;">... and ${results.errors.length - 5} more errors. Check console for details.</span>`;
                    }
                }
                
                // Show results section
                const resultsDiv = document.getElementById('syncResults');
                const resultsContent = document.getElementById('syncResultsContent');
                if (resultsDiv && resultsContent) {
                    resultsContent.innerHTML = summaryHTML;
                    resultsDiv.style.display = 'block';
                    
                    // Scroll to results
                    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
            } catch (error) {
                console.error('Sync error:', error);
                alert(`Sync failed: ${error.message}`);
            } finally {
                // Re-enable button
                syncButton.disabled = false;
                syncButton.style.opacity = '1';
                syncButton.style.cursor = 'pointer';
                syncButton.textContent = originalButtonText;
            }
        }

        // OLD FUNCTIONS - Commented out, may be used for reference
        /*
        // Function for "Update" button
        async function updateProjectUsers(projectId, accountId, accessToken, progressId) {
            const progressEl = document.getElementById(progressId);
            const progressBar = document.getElementById(`${progressId.replace('projectProgress-','projectProgressBar-')}`) || null;
            const progressText = document.getElementById(`${progressId.replace('projectProgress-','projectProgressText-')}`) || null;
            if (progressEl) progressEl.style.display = 'block';
            if (progressBar) progressBar.style.width = '0%';
            if (progressText) progressText.textContent = 'Preparing update...';
            try {
                await window.updateProjectUsers(projectId, accountId, accessToken, progressId);
                if (progressBar) progressBar.style.width = '100%';
                if (progressText) progressText.textContent = 'Update completed.';
                setTimeout(() => { if (progressEl) progressEl.style.display = 'none'; }, 2500);
                alert('Update Users operation completed successfully!');
            } catch (error) {
                if (progressText) progressText.textContent = `Update failed: ${error.message}`;
                alert(`Update Users operation failed: ${error.message}`);
            }
        }

        // Function for "Add New" button
        async function addNewProjectUsers(projectId, accountId, accessToken, progressId) {
            const progressEl = document.getElementById(progressId);
            const progressBar = document.getElementById(`${progressId.replace('projectProgress-','projectProgressBar-')}`) || null;
            const progressText = document.getElementById(`${progressId.replace('projectProgress-','projectProgressText-')}`) || null;
            if (progressEl) progressEl.style.display = 'block';
            if (progressBar) progressBar.style.width = '0%';
            if (progressText) progressText.textContent = 'Preparing add...';
            try {
                await window.addNewProjectUsers(projectId, accountId, accessToken, progressId);
                if (progressBar) progressBar.style.width = '100%';
                if (progressText) progressText.textContent = 'Add completed.';
                setTimeout(() => { if (progressEl) progressEl.style.display = 'none'; }, 2500);
                alert('Add New Users operation completed successfully!');
            } catch (error) {
                if (progressText) progressText.textContent = `Add failed: ${error.message}`;
                alert(`Add New Users operation failed: ${error.message}`);
            }
        }

        // Function for "Delete" button  
        async function deleteProjectUsers(projectId, accessToken, progressId) {
            const confirmed = confirm(`Are you sure you want to delete users from this project?\n\nThis will remove users that exist in the project but not in the User Main List.\n\nThis action cannot be undone.`);
            if (confirmed) {
                const progressEl = document.getElementById(progressId);
                const progressBar = document.getElementById(`${progressId.replace('projectProgress-','projectProgressBar-')}`) || null;
                const progressText = document.getElementById(`${progressId.replace('projectProgress-','projectProgressText-')}`) || null;
                if (progressEl) progressEl.style.display = 'block';
                if (progressBar) progressBar.style.width = '0%';
                if (progressText) progressText.textContent = 'Preparing deletion...';
                try {
                    await window.deleteProjectUsers(projectId, accessToken, progressId);
                    if (progressBar) progressBar.style.width = '100%';
                    if (progressText) progressText.textContent = 'Delete completed.';
                    setTimeout(() => { if (progressEl) progressEl.style.display = 'none'; }, 2500);
                    alert('Delete Users operation completed successfully!');
                } catch (error) {
                    if (progressText) progressText.textContent = `Delete failed: ${error.message}`;
                    alert(`Delete Users operation failed: ${error.message}`);
                }
            }
        }
        */

        async function fetchAllProjectUsers(projectId, accessToken) {
            let allUsers = [];
            let offset = 0;
            const limit = 100;
            let hasMoreData = true;

            while (hasMoreData) {
                const queryParams = new URLSearchParams({
                    'limit': limit.toString(),
                    'offset': offset.toString()
                });

                const apiUrl = `https://developer.api.autodesk.com/construction/admin/v1/projects/${projectId}/users?${queryParams}`;
                console.log(`Fetching users: ${apiUrl}`);

                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                        console.log('Error response:', errorData);
                    } catch (parseError) {
                        const textError = await response.text();
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${textError}`);
                    }
                    
                    const errorMessage = errorData.message || 
                                       errorData.error || 
                                       errorData.error_description || 
                                       (errorData.errors && errorData.errors[0] && errorData.errors[0].detail) ||
                                       `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMessage);
                }

                const usersData = await response.json();
                console.log(`Fetched ${usersData.results?.length || 0} users at offset ${offset}`);

                if (usersData.results && usersData.results.length > 0) {
                    allUsers = allUsers.concat(usersData.results);

                    // Update loading message with progress
                    const loadingMessage = document.getElementById('usersLoadingMessage');
                    const totalExpected = usersData.pagination ? usersData.pagination.totalResults : 'unknown';
                    loadingMessage.textContent = `Loading users... Found ${allUsers.length}${totalExpected !== 'unknown' ? ` of ${totalExpected}` : ''} users so far.`;

                    // Check pagination
                    if (usersData.pagination && usersData.pagination.totalResults) {
                        if (allUsers.length >= usersData.pagination.totalResults) {
                            hasMoreData = false;
                        } else {
                            offset += limit;
                        }
                    } else {
                        if (usersData.results.length < limit) {
                            hasMoreData = false;
                        } else {
                            offset += limit;
                        }
                    }
                } else {
                    hasMoreData = false;
                }

                // Safety check
                if (offset > 10000) {
                    console.warn('Stopping at 10,000 users for safety');
                    hasMoreData = false;
                }
            }

            return allUsers;
        }

        // Get 2-legged access token for HQ API
        async function get2LeggedToken() {
            const TOKEN_URL = 'https://developer.api.autodesk.com/authentication/v2/token';
            
            const data = new URLSearchParams();
            data.append('client_id', CLIENT_ID);
            data.append('client_secret', CLIENT_SECRET);
            data.append('grant_type', 'client_credentials');
            data.append('scope', 'account:read');

            try {
                const response = await fetch(TOKEN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: data
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const tokenData = await response.json();
                console.log('Got 2-legged token for HQ API');
                return tokenData.access_token;
            } catch (error) {
                console.error('Error getting 2-legged token:', error);
                throw new Error(`Authentication error: ${error.message}`);
            }
        }

        async function showAccountUsers(accountId, accountName, accessToken) {
            createAccountUsersModal();
            
            const modalTitle = document.getElementById('accountModalTitle');
            const loadingMessage = document.getElementById('accountUsersLoadingMessage');
            const tableContainer = document.getElementById('accountUsersTableContainer');
            const errorMessage = document.getElementById('accountUsersErrorMessage');
            
            modalTitle.textContent = `Users in Account: ${accountName}`;
            
            accountUsersModal.style.display = 'block';
            loadingMessage.style.display = 'block';
            tableContainer.style.display = 'none';
            errorMessage.style.display = 'none';

            try {
                loadingMessage.textContent = 'Getting authentication token...';
                const twoLeggedToken = await get2LeggedToken();
                
                loadingMessage.textContent = 'Loading users...';
                const allUsers = await fetchAllAccountUsers(accountId, twoLeggedToken);
                displayAccountUsersInTable(allUsers, accountName);
                
                loadingMessage.style.display = 'none';
                tableContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching account users:', error);
                loadingMessage.style.display = 'none';
                errorMessage.textContent = `Failed to load users: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        }

        function createAccountUsersModal() {
            if (accountUsersModal) return;

            const modalHTML = `
                <div id="accountUsersModal" class="account-users-modal" style="display: none;">
                    <div class="account-users-modal-content">
                        <div class="account-users-modal-header">
                            <h3 id="accountModalTitle">Account Users</h3>
                            <span class="account-users-modal-close">&times;</span>
                        </div>
                        <div class="account-users-modal-body">
                            <div id="accountUsersLoadingMessage">Loading users...</div>
                            <div id="accountUsersTableContainer" style="display: none;">
                                <div id="accountUsersFilterSection" style="margin-bottom: 15px;">
                                    <input type="text" id="accountUsersFilter" placeholder="Filter by email..." 
                                           style="padding: 8px; width: 300px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                                    <button onclick="filterAccountUsers()" 
                                            style="padding: 8px 12px; margin-left: 10px; background-color: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Filter
                                    </button>
                                    <button onclick="clearAccountUsersFilter()" 
                                            style="padding: 8px 12px; margin-left: 5px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Clear
                                    </button>
                                    <span id="accountUsersFilterInfo" style="margin-left: 15px; color: #666; font-style: italic;"></span>
                                </div>
                                <table id="accountUsersTable">
                                    <thead>
                                        <tr>
                                            <th>Email</th>
                                            <th>Default Role</th>
                                            <th>Company</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accountUsersTableBody">
                                    </tbody>
                                </table>
                            </div>
                            <div id="accountUsersErrorMessage" style="display: none; color: red;"></div>
                        </div>
                    </div>
                </div>
            `;

            const styles = `
                <style>
                    .account-users-modal {
                        position: fixed;
                        z-index: 1001;
                        left: 0;
                        top: 0;
                        width: 100%;
                        height: 100%;
                        background-color: rgba(0,0,0,0.5);
                    }

                    .account-users-modal-content {
                        background-color: #fefefe;
                        margin: 3% auto;
                        padding: 0;
                        border: 1px solid #888;
                        width: 90%;
                        max-width: 1000px;
                        border-radius: 8px;
                        max-height: 85vh;
                        display: flex;
                        flex-direction: column;
                    }

                    .account-users-modal-header {
                        padding: 15px 20px;
                        background-color: #e8f4f8;
                        border-bottom: 1px solid #ddd;
                        border-radius: 8px 8px 0 0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .account-users-modal-header h3 {
                        margin: 0;
                        color: #333;
                    }

                    .account-users-modal-close {
                        color: #aaa;
                        font-size: 28px;
                        font-weight: bold;
                        cursor: pointer;
                        line-height: 1;
                    }

                    .account-users-modal-close:hover,
                    .account-users-modal-close:focus {
                        color: #000;
                    }

                    .account-users-modal-body {
                        padding: 20px;
                        flex-grow: 1;
                        overflow-y: auto;
                    }

                    #accountUsersTable {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 10px;
                    }

                    #accountUsersTable th,
                    #accountUsersTable td {
                        border: 1px solid #ddd;
                        padding: 12px;
                        text-align: left;
                    }

                    #accountUsersTable th {
                        background-color: #f8f9fa;
                        font-weight: bold;
                        position: sticky;
                        top: 0;
                    }

                    #accountUsersTable tr:nth-child(even) {
                        background-color: #f9f9f9;
                    }

                    #accountUsersTable tr:hover {
                        background-color: #f0f8ff;
                    }

                    #accountUsersLoadingMessage {
                        text-align: center;
                        padding: 40px;
                        font-size: 16px;
                        color: #666;
                    }
                </style>
            `;

            document.head.insertAdjacentHTML('beforeend', styles);
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            accountUsersModal = document.getElementById('accountUsersModal');
            setupAccountModalEvents();
            
            // Add Enter key support for filter input
            const filterInput = document.getElementById('accountUsersFilter');
            if (filterInput) {
                filterInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        filterAccountUsers();
                    }
                });
            }
        }

        function setupAccountModalEvents() {
            const closeBtn = document.querySelector('.account-users-modal-close');

            closeBtn.addEventListener('click', () => {
                closeAccountUsersModal();
            });

            window.addEventListener('click', (event) => {
                if (event.target === accountUsersModal) {
                    closeAccountUsersModal();
                }
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && accountUsersModal && accountUsersModal.style.display === 'block') {
                    closeAccountUsersModal();
                }
            });
        }

        function closeAccountUsersModal() {
            if (accountUsersModal) {
                accountUsersModal.style.display = 'none';
                document.getElementById('accountUsersTableBody').innerHTML = '';
                document.getElementById('accountUsersLoadingMessage').textContent = 'Loading users...';
                document.getElementById('accountUsersLoadingMessage').style.display = 'block';
                document.getElementById('accountUsersTableContainer').style.display = 'none';
                document.getElementById('accountUsersErrorMessage').style.display = 'none';
                
                // Clear filter data
                originalAccountUsers = [];
                currentAccountName = '';
                document.getElementById('accountUsersFilter').value = '';
                document.getElementById('accountUsersFilterInfo').textContent = '';
            }
        }

        // Function to get 2-legged access token for HQ API
        async function get2LeggedToken() {
            const TOKEN_URL = 'https://developer.api.autodesk.com/authentication/v2/token';
            
            const data = new URLSearchParams();
            data.append('client_id', CLIENT_ID);
            data.append('client_secret', CLIENT_SECRET);
            data.append('grant_type', 'client_credentials');
            data.append('scope', 'account:read');

            try {
                const response = await fetch(TOKEN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: data
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Token error: ${errorData.error_description || 'Unknown error'}`);
                }
                
                const tokenData = await response.json();
                console.log('Got 2-legged token for HQ API');
                return tokenData.access_token;
            } catch (error) {
                console.error('Error getting 2-legged token:', error);
                throw new Error(`Authentication error: ${error.message}`);
            }
        }

        async function showAccountUsers(accountId, accountName, accessToken) {
            createAccountUsersModal();
            
            const modalTitle = document.getElementById('accountModalTitle');
            const loadingMessage = document.getElementById('accountUsersLoadingMessage');
            const tableContainer = document.getElementById('accountUsersTableContainer');
            const errorMessage = document.getElementById('accountUsersErrorMessage');
            
            modalTitle.textContent = `Users in Account: ${accountName}`;
            
            accountUsersModal.style.display = 'block';
            loadingMessage.style.display = 'block';
            tableContainer.style.display = 'none';
            errorMessage.style.display = 'none';

            try {
                // Get 2-legged token for HQ API
                loadingMessage.textContent = 'Getting authentication token...';
                const twoLeggedToken = await get2LeggedToken();
                
                // Fetch users with 2-legged token
                loadingMessage.textContent = 'Loading users...';
                const allUsers = await fetchAllAccountUsers(accountId, twoLeggedToken);
                displayAccountUsersInTable(allUsers, accountName);
                
                loadingMessage.style.display = 'none';
                tableContainer.style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching account users:', error);
                loadingMessage.style.display = 'none';
                errorMessage.textContent = `Failed to load users: ${error.message}`;
                errorMessage.style.display = 'block';
            }
        }

        async function fetchAllAccountUsers(accountId, accessToken) {
            let allUsers = [];
            let offset = 0;
            const limit = 100;
            let hasMoreData = true;

            while (hasMoreData) {
                const queryParams = new URLSearchParams({
                    'limit': limit.toString(),
                    'offset': offset.toString()
                });

                const apiUrl = `https://developer.api.autodesk.com/hq/v1/accounts/${accountId}/users?${queryParams}`;
                console.log(`Fetching account users: ${apiUrl}`);

                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log(`API Response Status: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json();
                        console.log('Error response data:', errorData);
                    } catch (parseError) {
                        const textError = await response.text();
                        throw new Error(`API error ${response.status}: ${response.statusText} - ${textError}`);
                    }
                    
                    const errorMessage = errorData.message || 
                                       errorData.error || 
                                       errorData.error_description || 
                                       errorData.detail ||
                                       `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMessage);
                }

                const usersData = await response.json();
                console.log(`Fetched ${usersData.length || 0} users at offset ${offset}`, usersData);

                if (usersData && Array.isArray(usersData) && usersData.length > 0) {
                    allUsers = allUsers.concat(usersData);

                    const loadingMessage = document.getElementById('accountUsersLoadingMessage');
                    loadingMessage.textContent = `Loading users... Found ${allUsers.length} users so far.`;

                    if (usersData.length < limit) {
                        hasMoreData = false;
                    } else {
                        offset += limit;
                    }
                } else {
                    hasMoreData = false;
                }

                if (offset > 10000) {
                    console.warn('Stopping pagination at 10,000 users for safety');
                    hasMoreData = false;
                }
            }

            return allUsers;
        }

        // Store original account users data for filtering
        let originalAccountUsers = [];
        let currentAccountName = '';

        function displayAccountUsersInTable(users, accountName) {
            // Store original data for filtering
            originalAccountUsers = users
                .filter(user => user.email)
                .sort((a, b) => a.email.localeCompare(b.email));
            currentAccountName = accountName;
            
            // Clear filter
            document.getElementById('accountUsersFilter').value = '';
            document.getElementById('accountUsersFilterInfo').textContent = '';
            
            // Display all users initially
            renderAccountUsersTable(originalAccountUsers);
        }

        function renderAccountUsersTable(usersToDisplay) {
            const tableBody = document.getElementById('accountUsersTableBody');
            tableBody.innerHTML = '';

            usersToDisplay.forEach((user, index) => {
                const row = document.createElement('tr');
                
                const emailCell = document.createElement('td');
                emailCell.textContent = user.email || 'N/A';
                row.appendChild(emailCell);
                
                const roleCell = document.createElement('td');
                roleCell.textContent = user.default_role || user.role || 'N/A';
                row.appendChild(roleCell);
                
                const companyCell = document.createElement('td');
                companyCell.textContent = user.company || user.company_name || 'N/A';
                row.appendChild(companyCell);
                
                tableBody.appendChild(row);
            });

            const modalTitle = document.getElementById('accountModalTitle');
            const filterText = document.getElementById('accountUsersFilter').value;
            const titleSuffix = filterText ? 
                ` (${usersToDisplay.length} filtered / ${originalAccountUsers.length} total)` :
                ` (${usersToDisplay.length} users)`;
            modalTitle.textContent = `Users in Account: ${currentAccountName}${titleSuffix}`;
        }

        function filterAccountUsers() {
            if (!originalAccountUsers || originalAccountUsers.length === 0) return;

            const filterText = document.getElementById('accountUsersFilter').value.toLowerCase().trim();
            const filterInfo = document.getElementById('accountUsersFilterInfo');
            
            if (!filterText) {
                // No filter, show all users
                renderAccountUsersTable(originalAccountUsers);
                filterInfo.textContent = '';
                return;
            }

            // Filter users by email
            const filteredUsers = originalAccountUsers.filter(user => 
                user.email.toLowerCase().includes(filterText)
            );

            renderAccountUsersTable(filteredUsers);
            
            // Update filter info
            if (filteredUsers.length === 0) {
                filterInfo.textContent = 'No users found matching the filter.';
                filterInfo.style.color = '#dc3545';
            } else if (filteredUsers.length === originalAccountUsers.length) {
                filterInfo.textContent = 'Filter matches all users.';
                filterInfo.style.color = '#28a745';
            } else {
                filterInfo.textContent = `Showing ${filteredUsers.length} of ${originalAccountUsers.length} users.`;
                filterInfo.style.color = '#007cba';
            }
        }

        function clearAccountUsersFilter() {
            document.getElementById('accountUsersFilter').value = '';
            document.getElementById('accountUsersFilterInfo').textContent = '';
            if (originalAccountUsers && originalAccountUsers.length > 0) {
                renderAccountUsersTable(originalAccountUsers);
            }
        }

    </script>

    <!-- Load User Table Management Module -->
    <script src="user-table.js?v=2025110901"></script>
    <script src="update_account_users.js?v=2025110205"></script>
    <script src="get_account_users.js?v=2025110205"></script>
    <script src="get_project_users.js?v=20251109171700"></script>
    <script src="manage_project_users.js?v=2025110206"></script>
    <script src="update_folder_permission.js?v=2025120107"></script>
    <script src="read_project_folders.js?v=2025120115"></script>
    <script src="folders_permissions.js?v=2025110301"></script>
    <script>
        // Initialize user table management when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing user table...');
            initUserTable();
        });
        
        // Fallback for cases where DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM loaded (delayed), initializing user table...');
                initUserTable();
            });
        } else {
            console.log('DOM already loaded, initializing user table immediately...');
            initUserTable();
        }
    </script>

    <!-- User Management Modal -->
    <div id="userManagementModal" class="user-modal">
        <div class="user-modal-content">
            <div class="user-modal-header">
                <h3>User Management</h3>
                <span class="user-modal-close">&times;</span>
            </div>
            <div id="modalHubInfo" style="padding: 10px 20px; background: #f0f7ff; border-bottom: 1px solid #d0e4f7; font-size: 13px; color: #333;">
                <strong>Current Hub:</strong> <span id="modalHubName">Not selected</span>
                <span id="modalHubId" style="color: #666; font-size: 12px; margin-left: 10px;"></span>
            </div>
            <div class="user-modal-body">
                <div class="modal-table-actions">
                    <div>
                        <button onclick="addModalRow()">Add Row</button>
                        <button onclick="deleteSelectedModalRows()">Delete Row</button>
                        <button onclick="clearModalTable()">Clear Table</button>
                    </div>
                    <div>
                        <button onclick="saveModalTableToJson()">Save Users Setting</button>
                        <button onclick="importCSV()">Import CSV</button>
                    </div>
                </div>
                
                <!-- Hidden file input for CSV import -->
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" />
                
                <!-- Duplicate email alert (hidden by default) -->
                <div id="duplicateEmailAlert" style="display: none; margin: 15px 0; padding: 15px; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; color: #721c24;">
                    <strong>‚ùå Cannot save: Duplicate emails found!</strong>
                    <div id="duplicateEmailList" style="margin-top: 10px; font-size: 13px;"></div>
                    <div style="margin-top: 10px; font-style: italic; font-size: 13px;">Please remove email duplicates before saving.</div>
                </div>
                
                <div class="modal-table-summary" id="modalTableSummary">
                    Total Users: 0
                </div>

                <div class="modal-table-container">
                    <table id="modalUserTable" class="modal-table">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" id="selectAllCheckbox" style="cursor: pointer;">
                                </th>
                                <th class="modal-editable">Email</th>
                                <th class="modal-editable">Company</th>
                                <th class="modal-editable">Role</th>
                                <th>Project Admin</th>
                                <th>Insight</th>
                                <th>Docs</th>
                                <th>Design Collaboration</th>
                                <th>Model Coordination</th>
                                <th>Build</th>
                                <th>Cost</th>
                                <th>Forma</th>
                                <th>Take Off</th>
                            </tr>
                        </thead>
                        <tbody id="modalTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</body>
</html>